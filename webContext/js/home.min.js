function doAlert(){alert("错误：无法连接到kiftd服务器，请检查您的网络连接或查看服务器运行状态。")}function getServerOS(){$.ajax({type:"POST",dataType:"text",data:{},url:"homeController/getServerOS.ajax",success:function(a){"mustLogin"==a&&(window.location.href="login.html"),$("#serverOS").text(a)},error:function(){$("#serverOS").html("<a onclick='getServerOS()'>获取失败，点击重试</a>")}})}function showFolderView(fid){startLoading(),$.ajax({type:"POST",dataType:"text",data:{fid:fid},url:"homeController/getFolderView.ajax",success:function(result){endLoading(),"mustLogin"==result?window.location.href="login.html":"notAccess"==result?window.location.href="/":(folderView=eval("("+result+")"),locationpath=folderView.folder.folderId,parentpath=folderView.folder.folderParent,constraintLevel=folderView.folder.folderConstraint,showParentList(folderView),showAccountView(folderView),showPublishTime(folderView),originFolderView=$.extend(!0,{},folderView),$("#sortByFN").removeClass(),$("#sortByCD").removeClass(),$("#sortByFS").removeClass(),$("#sortByCN").removeClass(),showFolderTable(folderView))},error:function(){endLoading(),doAlert(),$("#tb").html("<span class='graytext'>获取失败，请尝试刷新</span>"),$("#publishTime").html("<span class='graytext'>获取失败，请尝试刷新</span>"),$("#parentlistbox").html("<span class='graytext'>获取失败，请尝试刷新</span>")}})}function startLoading(){$("#loadingModal").modal({backdrop:"static",keyboard:!1}),$("#loadingModal").modal("show")}function endLoading(){$("#loadingModal").modal("hide")}function startLogin(){$("#accountid").attr("disabled","disabled"),$("#accountpwd").attr("disabled","disabled"),$("#dologinButton").attr("disabled","disabled")}function finishLogin(){$("#accountid").removeAttr("disabled","disabled"),$("#accountpwd").removeAttr("disabled","disabled"),$("#dologinButton").removeAttr("disabled","disabled")}function dologin(){var accountId=$("#accountid").val(),accountPwd=$("#accountpwd").val(),check="y";0==accountId.length?($("#accountidbox").addClass("has-error"),check="n"):$("#accountidbox").removeClass("has-error"),0==accountPwd.length?($("#accountpwdbox").addClass("has-error"),check="n"):$("#accountpwdbox").removeClass("has-error"),"y"==check&&(startLogin(),$.ajax({url:"homeController/getPublicKey.ajax",type:"POST",data:{},dataType:"text",success:function(result){var encrypted,publicKeyInfo=eval("("+result+")"),date=new Date,loginInfo='{accountId:"'+accountId+'",accountPwd:"'+accountPwd+'",time:"'+publicKeyInfo.time+'"}',encrypt=new JSEncrypt;encrypt.setPublicKey(publicKeyInfo.publicKey),encrypted=encrypt.encrypt(loginInfo),sendLoginInfo(encrypted)},error:function(){finishLogin(),$("#alertbox").addClass("alert"),$("#alertbox").addClass("alert-danger"),$("#alertbox").text("提示：登录请求失败，请检查网络或服务器运行状态")}}))}function sendLoginInfo(a){$.ajax({type:"POST",dataType:"text",url:"homeController/doLogin.ajax",data:{encrypted:a},success:function(a){switch(finishLogin(),$("#alertbox").removeClass("alert"),$("#alertbox").removeClass("alert-danger"),$("#alertbox").text(""),a){case"permitlogin":$("#accountidbox").removeClass("has-error"),$("#accountpwdbox").removeClass("has-error"),$("#loginModal").modal("hide"),showFolderView(locationpath);break;case"accountnotfound":$("#accountidbox").addClass("has-error"),$("#accountpwdbox").removeClass("has-error"),$("#alertbox").addClass("alert"),$("#alertbox").addClass("alert-danger"),$("#alertbox").text("提示：登录失败，账户不存在或未设置");break;case"accountpwderror":$("#accountpwdbox").addClass("has-error"),$("#accountidbox").removeClass("has-error"),$("#alertbox").addClass("alert"),$("#alertbox").addClass("alert-danger"),$("#alertbox").text("提示：登录失败，密码错误或未设置");break;case"error":$("#alertbox").addClass("alert"),$("#alertbox").addClass("alert-danger"),$("#alertbox").text("提示：登录失败，登录请求无法通过效验（可能是请求耗时过长导致的）");break;default:$("#alertbox").addClass("alert"),$("#alertbox").addClass("alert-danger"),$("#alertbox").text("提示：无法登录，未知错误")}},error:function(){finishLogin(),$("#alertbox").addClass("alert"),$("#alertbox").addClass("alert-danger"),$("#alertbox").text("提示：登录请求失败，请检查网络或服务器运行状态")}})}function dologout(){$("#logoutModal").modal("hide"),$.ajax({url:"homeController/doLogout.ajax",type:"POST",data:{},dataType:"text",success:function(a){"SUCCESS"==a&&showFolderView(locationpath)},error:function(){doAlert()}})}function showParentList(a){var b,c;$("#parentlistbox").html(""),b=a.folder,c=0,$.each(a.parentList,function(a,b){3>=c&&($("#parentlistbox").append("<button onclick='entryFolder(\""+b.folderId+'"'+")' class='btn btn-link btn-xs'>"+b.folderName+"</button> / "),c++)}),c>3&&$("#parentlistbox").append("... / "),$("#parentlistbox").append(b.folderName)}function showAccountView(a){$("#tb").html(""),account=a.account,null!=a.account?$("#tb").append("<button class='btn btn-link rightbtn' data-toggle='modal' data-target='#logoutModal'>注销 ["+a.account+"] <span class='glyphicon glyphicon-off' aria-hidden='true'></span></button>"):$("#tb").append("<button class='btn btn-link rightbtn' data-toggle='modal' data-target='#loginModal'>登入<span class='glyphicon glyphicon-user' aria-hidden='true'></span></button>");var b=a.authList;null!=b&&(checkAuth(b,"C")&&$("#parentlistbox").append("<button onclick='showNewFolderModel()' class='btn btn-link btn-xs rightbtn'><span class='glyphicon glyphicon-folder-open'></span> 新建文件夹</button>"),checkAuth(b,"U")&&$("#parentlistbox").append("<button onclick='showUploadFileModel()' class='btn btn-link btn-xs rightbtn'><span class='glyphicon glyphicon-cloud-upload'></span> 上传文件</button>"),checkAuth(b,"L")&&$("#parentlistbox").append("<button onclick='showDownloadAllCheckedModel()' class='btn btn-link btn-xs rightbtn'><span class='glyphicon glyphicon-cloud-download'></span> 打包下载</button>"),checkAuth(b,"D")&&$("#parentlistbox").append("<button onclick='showDeleteAllCheckedModel()' class='btn btn-link btn-xs rightbtn'><span class='glyphicon glyphicon-trash'></span> 批量删除</button>"),checkAuth(b,"M")&&($("#parentlistbox").append("<button onclick='startMoveFile()' class='btn btn-link btn-xs rightbtn'><span id='cutSignSp' class='glyphicon glyphicon-scissors'></span> <span id='cutSignTx'>剪切</span></button>"),void 0!==checkedMovefiles&&checkedMovefiles.length>0&&($("#cutSignTx").text("粘贴（"+checkedMovefiles.length+"）"),$("#cutSignSp").removeClass(),$("#cutSignSp").addClass("glyphicon glyphicon-import"))))}function checkAuth(a,b){var c=!1;return $.each(a,function(a,d){d==b&&(c=!0)}),c}function showPublishTime(a){$("#publishTime").html("");var b="";b=null!=a.publishTime?a.publishTime:"--",$("#publishTime").text(b)}function refreshFolderView(){null!=locationpath&&locationpath.length>0?showFolderView(locationpath):showFolderView("root")}function returnPF(){null!=parentpath&&"null"!=parentpath?showFolderView(parentpath):showFolderView("root")}function showFolderTable(a){var b,c,d,e;$("#foldertable").html(""),null!=parentpath&&"null"!=parentpath&&$("#foldertable").append("<tr onclick='returnPF()'><td><button onclick='returnPF()' class='btn btn-link btn-xs'>../</button></td><td>--</td><td>--</td><td>--</td><td>--</td></tr>"),b=a.authList,c=!1,d=!1,e=!1,checkAuth(b,"D")&&(c=!0),checkAuth(b,"R")&&(d=!0),checkAuth(b,"L")&&(e=!0),$.each(a.folderList,function(a,b){var e="<tr><td><button onclick='entryFolder(\""+b.folderId+'"'+")' class='btn btn-link btn-xs'>/"+b.folderName+"</button></td><td>"+b.folderCreationDate+"</td><td>--</td><td>"+b.folderCreator+"</td><td>";c&&(e=e+"<button onclick='showDeleteFolderModel("+'"'+b.folderId+'","'+b.folderName+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-remove'></span> 删除</button>"),d&&(e=e+"<button onclick='showRenameFolderModel("+'"'+b.folderId+'","'+b.folderName+'",'+b.folderConstraint+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-wrench'></span> 编辑</button>"),d||c||(e+="--"),e+="</td></tr>",$("#foldertable").append(e)}),$.each(a.fileList,function(a,b){var f="<tr onclick='checkfile(\""+b.fileId+'"'+")' id='"+b.fileId+"' class='filerow'><td>"+b.fileName+"</td><td>"+b.fileCreationDate+"</td><td>"+b.fileSize+"MB</td><td>"+b.fileCreator+"</td><td>";e&&(f=f+"<button onclick='showDownloadModel("+'"'+b.fileId+'","'+b.fileName+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-cloud-download'></span> 下载</button>","mp4"==getSuffix(b.fileName)||"webm"==getSuffix(b.fileName)?f=f+"<button onclick='playVideo("+'"'+b.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-play'></span> 播放</button>":"pdf"==getSuffix(b.fileName)?f=f+"<button onclick='pdfView("+'"'+b.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-eye-open'></span> 预览</button>":"jpg"==getSuffix(b.fileName)||"jpeg"==getSuffix(b.fileName)||"gif"==getSuffix(b.fileName)||"png"==getSuffix(b.fileName)||"bmp"==getSuffix(b.fileName)?f=f+"<button onclick='showPicture("+'"'+b.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-picture'></span> 查看</button>":("mp3"==getSuffix(b.fileName)||"wav"==getSuffix(b.fileName)||"ogg"==getSuffix(b.fileName))&&(f=f+"<button onclick='playAudio("+'"'+b.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-play'></span> 播放</button>")),c&&(f=f+"<button onclick='showDeleteFileModel("+'"'+b.fileId+'","'+b.fileName+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-remove'></span> 删除</button>"),d&&(f=f+"<button onclick='showRenameFileModel("+'"'+b.fileId+'"'+","+'"'+b.fileName+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-wrench'></span> 重命名</button>"),d||c||e||(f+="--"),f+="</td></tr>",$("#foldertable").append(f)})}function showNewFolderModel(){$("#newFolderModal").modal("show")}function changeNewFolderType(a){$("#newfoldertype").text(folderTypes[a]),$("#foldername").attr("folderConstraintLevel",a+"")}function createfolder(){var a=$("#foldername").val(),b=$("#foldername").attr("folderConstraintLevel"),c=new RegExp("^[0-9a-zA-Z_\\u4E00-\\u9FFF]+$","g");0==a.length?showFolderAlert("提示：文件夹名称不能为空。"):a.length>20?showFolderAlert("提示：文件夹名称太长。"):c.test(a)?($("#folderalert").removeClass("alert"),$("#folderalert").removeClass("alert-danger"),$("#foldernamebox").removeClass("has-error"),$("#folderalert").text(""),$.ajax({type:"POST",dataType:"text",data:{parentId:locationpath,folderName:a,folderConstraint:b},url:"homeController/newFolder.ajax",success:function(a){"mustLogin"==a?window.location.href="login.html":"noAuthorized"==a?showFolderAlert("提示：您的操作未被授权，创建文件夹失败"):"errorParameter"==a?showFolderAlert("提示：参数不正确，创建文件夹失败"):"cannotCreateFolder"==a?showFolderAlert("提示：出现意外错误，可能未能创建文件夹"):"folderAlreadyExist"==a?showFolderAlert("提示：该文件夹已经存在，请更换文件夹名称"):"createFolderSuccess"==a?($("#newFolderModal").modal("hide"),showFolderView(locationpath)):($("#newFolderModal").modal("hide"),showFolderView(locationpath))},error:function(){showFolderAlert("提示：出现意外错误，可能未能创建文件夹")}})):showFolderAlert("提示：文件夹名只能包含英文字母、数组、汉字和下划线。")}function showFolderAlert(a){$("#folderalert").addClass("alert"),$("#folderalert").addClass("alert-danger"),$("#foldernamebox").addClass("has-error"),$("#folderalert").text(a)}function entryFolder(a){showFolderView(a)}function showDeleteFolderModel(a,b){$("#deleteFolderBox").html("<button id='dmbutton' type='button' class='btn btn-danger' onclick='deleteFolder(\""+a+'"'+")'>删除</button>"),$("#dmbutton").attr("disabled",!1),$("#deleteFolderMessage").text("提示：确定要彻底删除文件夹：["+b+"]及其全部内容么？该操作不可恢复"),$("#deleteFolderModal").modal("toggle")}function deleteFolder(a){$("#dmbutton").attr("disabled",!0),$("#deleteFolderMessage").text("提示：正在删除，请稍候..."),$.ajax({type:"POST",dataType:"text",data:{folderId:a},url:"homeController/deleteFolder.ajax",success:function(a){"mustLogin"==a?window.location.href="login.html":"noAuthorized"==a?($("#deleteFolderMessage").text("提示：您的操作未被授权，删除文件夹失败"),$("#dmbutton").attr("disabled",!1)):"errorParameter"==a?($("#deleteFolderMessage").text("提示：参数不正确，删除文件夹失败"),$("#dmbutton").attr("disabled",!1)):"cannotDeleteFolder"==a?($("#deleteFolderMessage").text("提示：出现意外错误，可能未能删除文件夹"),$("#dmbutton").attr("disabled",!1)):"deleteFolderSuccess"==a?($("#deleteFolderModal").modal("hide"),showFolderView(locationpath)):($("#deleteFolderMessage").text("提示：出现意外错误，可能未能删除文件夹"),$("#dmbutton").attr("disabled",!1))},error:function(){$("#deleteFolderMessage").text("提示：出现意外错误，可能未能删除文件夹"),$("#dmbutton").attr("disabled",!1)}})}function showRenameFolderModel(a,b,c){$("#renameFolderBox").html("<button type='button' class='btn btn-primary' onclick='renameFolder(\""+a+'"'+")'>修改</button>"),$("#newfoldername").val(b),changeEditFolderType(c),$("#renameFolderModal").modal("show")}function changeEditFolderType(a){$("#editfoldertype").text(folderTypes[a]),$("#newfoldername").attr("folderConstraintLevel",a+"")}function renameFolder(a){var b=$("#newfoldername").val(),c=$("#newfoldername").attr("folderConstraintLevel"),d=new RegExp("^[0-9a-zA-Z_\\u4E00-\\u9FFF]+$","g");0==b.length?showRenameFolderAlert("提示：文件夹名称不能为空。"):b.length>20?showRenameFolderAlert("提示：文件夹名称太长。"):d.test(b)?($("#newfolderalert").removeClass("alert"),$("#newfolderalert").removeClass("alert-danger"),$("#folderrenamebox").removeClass("has-error"),$("#newfolderalert").text(""),$.ajax({type:"POST",dataType:"text",data:{folderId:a,newName:b,folderConstraint:c},url:"homeController/renameFolder.ajax",success:function(a){"mustLogin"==a?window.location.href="login.html":"noAuthorized"==a?showRenameFolderAlert("提示：您的操作未被授权，编辑失败"):"errorParameter"==a?showRenameFolderAlert("提示：参数不正确，编辑失败"):"renameFolderSuccess"==a?($("#renameFolderModal").modal("hide"),showFolderView(locationpath)):showRenameFolderAlert("提示：出现意外错误，可能未能编辑文件夹")},error:function(){showRenameFolderAlert("提示：出现意外错误，可能未能编辑文件夹")}})):showRenameFolderAlert("提示：文件夹名只能包含英文字母、数组、汉字和下划线")}function showRenameFolderAlert(a){$("#newfolderalert").addClass("alert"),$("#newfolderalert").addClass("alert-danger"),$("#folderrenamebox").addClass("has-error"),$("#newfolderalert").text(a)}function showUploadFileModel(){$("#uploadFileAlert").removeClass("alert"),$("#uploadFileAlert").removeClass("alert-danger"),$("#uploadFileAlert").text(""),$("#uploadFileModal").modal("toggle")}function checkpath(){$("#uploadfile").click()}function getInputUpload(){fs=$("#uploadfile").get(0).files,showfilepath()}function showfilepath(){var b,a="";for(b=0;b<fs.length;b++)a+=fs[b].name,b<fs.length-1&&(a+="、");fs.length<=1?$("#selectcount").text(""):$("#selectcount").text("（共"+fs.length+"个）"),$("#filepath").val(a)}function checkUploadFile(){var a,b,c;for($("#umbutton").attr("disabled",!0),$("#uploadFileAlert").removeClass("alert"),$("#uploadFileAlert").removeClass("alert-danger"),$("#uploadFileAlert").text(""),a=new Array,b=0;b<fs.length;b++)a[b]=fs[b].name.replace(/^.+?\\([^\\]+?)?$/gi,"$1");c=JSON.stringify(a),$.ajax({type:"POST",dataType:"text",data:{folderId:locationpath,namelist:c},url:"homeController/checkUploadFile.ajax",success:function(a){"mustLogin"==a?window.location.href="login.html":"errorParameter"==a?showUploadFileAlert("提示：参数不正确，无法开始上传"):"noAuthorized"==a?showUploadFileAlert("提示：您的操作未被授权，无法开始上传"):a.startsWith("duplicationFileName:")?showUploadFileAlert("提示：本路径下已存在同名的文件:["+a.substring(20)+"]，无法开始上传"):"permitUpload"==a?doupload(1):showUploadFileAlert("提示：出现意外错误，无法开始上传")},error:function(){showUploadFileAlert("提示：出现意外错误，无法开始上传")}})}function doupload(a){var c,d,e,b=fs.length;$("#pros").width("0%"),c=fs[a-1],null!=c?(d=c.name,b>1&&$("#filecount").text("（"+a+"/"+b+"）"),$("#uploadstatus").prepend("<p>"+d+"<span id='uls_"+a+"'>[正在上传...]</span></p>"),xhr=new XMLHttpRequest,e=new FormData,e.append("file",c),e.append("folderId",locationpath),xhr.open("POST","homeController/douploadFile.ajax",!0),xhr.upload.addEventListener("progress",uploadProgress,!1),xhr.send(e),xhr.onloadend=function(){if(200===xhr.status){var c=xhr.responseText;"uploadsuccess"==c?($("#uls_"+a).text("[已完成]"),b>a?doupload(a+1):($("#uploadfile").val(""),$("#filepath").val(""),$("#pros").width("0%"),$("#uploadFileModal").modal("hide"),$("#umbutton").attr("disabled",!1),showFolderView(locationpath),$("#filecount").text(""),$("#uploadstatus").text(""),$("#selectcount").text(""))):"uploaderror"==c?(showUploadFileAlert("提示：出现意外错误，文件：["+d+"]上传失败，上传被中断。"),$("#uls_"+a).text("[失败]")):($("#uploadFileModal").modal("hide"),$("#uls_"+a).text("[失败]"))}else showUploadFileAlert("提示：出现意外错误，文件：["+d+"]上传失败，上传被中断。"),$("#uls_"+a).text("[失败]")}):(showUploadFileAlert("提示：要上传的文件不存在。"),$("#uploadstatus").prepend("<p>未找到要上传的文件<span id='uls_"+a+"'>[失败]</span></p>"))}function uploadProgress(a){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);$("#pros").width(b+"%")}}function showUploadFileAlert(a){$("#uploadFileAlert").addClass("alert"),$("#uploadFileAlert").addClass("alert-danger"),$("#uploadFileAlert").text(a),$("#umbutton").attr("disabled",!1)}function showDownloadModel(a,b){$("#downloadModal").modal("toggle"),$("#downloadFileName").text("提示：您确认要下载文件：["+b+"]么？"),$("#downloadFileBox").html("<button id='dlmbutton' type='button' class='btn btn-primary' onclick='dodownload(\""+a+'"'+")'>开始下载</button>"),$("#dlmbutton").attr("disabled",!1)}function dodownload(a){$("#dlmbutton").attr("disabled",!0),$("#downloadFileName").text("提示：准备开始下载，请稍候..."),setTimeout("$('#downloadModal').modal('hide');",800),window.location.href="homeController/downloadFile.do?fileId="+a}function showDeleteFileModel(a,b){$("#deleteFileBox").html("<button id='dfmbutton' type='button' class='btn btn-danger' onclick='deleteFile(\""+a+'"'+")'>删除</button>"),$("#dfmbutton").attr("disabled",!1),$("#deleteFileMessage").text("提示：确定要彻底删除文件：["+b+"]么？该操作不可恢复"),$("#deleteFileModal").modal("toggle")}function deleteFile(a){$("#dfmbutton").attr("disabled",!0),$("#deleteFileMessage").text("提示：正在删除，请稍候..."),$.ajax({type:"POST",dataType:"text",data:{fileId:a},url:"homeController/deleteFile.ajax",success:function(a){"mustLogin"==a?window.location.href="login.html":"noAuthorized"==a?($("#deleteFileMessage").text("提示：您的操作未被授权，删除失败"),$("#dfmbutton").attr("disabled",!1)):"errorParameter"==a?($("#deleteFileMessage").text("提示：参数不正确，删除失败"),$("#dfmbutton").attr("disabled",!1)):"cannotDeleteFile"==a?($("#deleteFileMessage").text("提示：出现意外错误，可能未能删除文件"),$("#dfmbutton").attr("disabled",!1)):"deleteFileSuccess"==a?($("#deleteFileModal").modal("hide"),showFolderView(locationpath)):($("#deleteFileMessage").text("提示：出现意外错误，可能未能删除文件"),$("#dfmbutton").attr("disabled",!1))},error:function(){$("#deleteFileMessage").text("提示：出现意外错误，可能未能删除文件"),$("#dfmbutton").attr("disabled",!1)}})}function showRenameFileModel(a,b){$("#newFileNamealert").removeClass("alert"),$("#newFileNamealert").removeClass("alert-danger"),$("#filerenamebox").removeClass("has-error"),$("#newFileNamealert").text(""),$("#renameFileBox").html("<button type='button' class='btn btn-primary' onclick='renameFile(\""+a+'"'+")'>修改</button>"),$("#newfilename").val(b),$("#renameFileModal").modal("toggle")}function renameFile(a){var b=new RegExp('[/|\\s\\\\*\\<\\>"]+',"g"),c=$("#newfilename").val();c.length>0?c.length<128?b.test(c)?showRenameFolderAlert("提示：文件名中不应含有：空格 引号 /  * | < > "):$.ajax({type:"POST",dataType:"text",data:{fileId:a,newFileName:c},url:"homeController/renameFile.ajax",success:function(a){"mustLogin"==a?window.location.href="login.html":"cannotRenameFile"==a?showRenameFolderAlert("提示：出现意外错误，可能未能重命名文件"):"renameFileSuccess"==a?($("#renameFileModal").modal("hide"),showFolderView(locationpath)):"errorParameter"==a?showRenameFolderAlert("提示：参数错误，重命名失败"):"noAuthorized"==a?showRenameFolderAlert("提示：您的操作未被授权，重命名失败"):showRenameFolderAlert("提示：出现意外错误，可能未能重命名文件")},error:function(){showRenameFolderAlert("提示：出现意外错误，可能未能重命名文件")}}):showRenameFolderAlert("提示：文件名称太长"):showRenameFolderAlert("提示：文件名不能为空")}function showRenameFolderAlert(a){$("#newFileNamealert").addClass("alert"),$("#newFileNamealert").addClass("alert-danger"),$("#filerenamebox").addClass("has-error"),$("#newFileNamealert").text(a)}function abortUpload(){null!=xhr&&(xhr.abort(),$("#umbutton").attr("disabled",!1),$("#pros").width("0%"),$("#filecount").text("")),$("#uploadfile").val(""),$("#filepath").val(""),$("#uploadstatus").html(""),$("#selectcount").text(""),$("#uploadFileModal").modal("hide"),showFolderView(locationpath)}function getSuffix(a){var b=a.lastIndexOf("."),c=a.length,d=a.substring(b+1,c);return d.toLowerCase()}function playVideo(a){window.open("quickview/video.html?fileId="+a)}function pdfView(a){window.open("homeController/pdfView.do?fileId="+a)}function showPicture(fileId){$.ajax({url:"homeController/getPrePicture.ajax",data:{fileId:fileId},type:"POST",dataType:"text",success:function(result){var pvl,imageslist;"ERROR"!=result?(pvl=eval("("+result+")"),imageslist=document.createElement("ul"),$.each(pvl.pictureViewList,function(a,b){var d,c=new Image;c.src=b.filePath.startsWith("homeController")?b.filePath:"fileblocks/"+b.filePath,c.alt=b.fileName,d=document.createElement("li"),d.appendChild(c),imageslist.appendChild(d)}),viewer=new Viewer(imageslist,{hidden:function(){viewer.destroy()}}),viewer.view(pvl.index),viewer.show()):alert("错误：无法定位要预览的文件或该操作未被授权。")},error:function(){alert("错误：请求失败，请刷新重试。")}})}function checkfile(a){window.event.shiftKey?$("#"+a).hasClass("info")?$("#"+a).removeClass("info"):$("#"+a).addClass("info"):($(".filerow").removeClass("info"),$("#"+a).addClass("info"))}function checkallfile(){checkAll?($(".filerow").addClass("info"),checkAll=!1):($(".filerow").removeClass("info"),checkAll=!0)}function showDownloadAllCheckedModel(){$("#downloadAllCheckedBox").html(""),$("#downloadAllCheckedLoad").text("");var a=$(".info").get();0==a.length?$("#downloadAllCheckedName").text("提示：您还未选择任何文件，请先选中一些文件后再执行本操作（点击某一文件行来选中单一文件；按住Shift并点击文件行选中多个文件；使用Shitf+A选中/取消选中所有文件）。"):($("#downloadAllCheckedName").text("提示：您确认要打包并下载这"+a.length+"项么？"),$("#downloadAllCheckedBox").html("<button id='dclmbutton' type='button' class='btn btn-primary' onclick='downloadAllChecked()'>开始下载</button>"),$("#dclmbutton").attr("disabled",!1)),$("#downloadAllCheckedModal").modal("toggle")}function downloadAllChecked(){var a,b,c,d;for($("#dclmbutton").attr("disabled",!0),a=$(".info").get(),b=new Array,c=0;c<a.length;c++)b[c]=a[c].id;d=JSON.stringify(b),$("#downloadAllCheckedName").text("提示：服务器正在对选中资源进行压缩（共"+a.length+"项），这可能需要一些时间（文件越大耗时越长），压缩完成将自动开始下载。"),$.ajax({url:"homeController/getPackTime.ajax",type:"POST",data:{strIdList:d},dataType:"text",success:function(a){var b;"0"!=a?(b=0,$("#downloadAllCheckedLoad").text("已耗时："+b+"秒（预计耗时："+a+"）"),zipTimer=setInterval(function(){b++,$("#downloadAllCheckedLoad").text("已耗时："+b+"秒（预计耗时："+a+"）")},1e3)):(b=0,$("#downloadAllCheckedLoad").text("已耗时："+b+"秒"),zipTimer=setInterval(function(){b++,$("#downloadAllCheckedLoad").text("已耗时："+b+"秒")},1e3))},error:function(){$("#downloadAllCheckedLoad").text("（无法获取预计耗时）")}}),$.ajax({type:"POST",url:"homeController/downloadCheckedFiles.ajax",data:{strIdList:d},dataType:"text",success:function(a){var c,d;null!=zipTimer&&window.clearInterval(zipTimer),"ERROR"==a?$("#downloadAllCheckedName").text("提示：压缩过程出错。无法完成压缩，请重试或告知管理员。"):($("#downloadAllCheckedLoad").text(""),$("#downloadAllCheckedName").text("提示：压缩完成！准备开始下载..."),setTimeout("$('#downloadAllCheckedModal').modal('hide');",800),c=document.createElement("form"),c.action="homeController/downloadCheckedFilesZip.do",c.method="post",c.style.display="none",d=document.createElement("input"),d.name="zipId",d.value=a,c.appendChild(d),document.body.appendChild(c),c.submit())},error:function(){$("#downloadAllCheckedName").text("提示：请求失败。无法完成压缩，请重试或告知管理员。")}})}function showDeleteAllCheckedModel(){$("#deleteFileBox").html("");var a=$(".info").get();$("#dfmbutton").attr("disabled",!1),0==a.length?$("#deleteFileMessage").text("提示：您还未选择任何文件，请先选中一些文件后再执行本操作（点击某一文件行来选中单一文件；按住Shift并点击文件行选中多个文件；使用Shift+A选中/取消选中所有文件）。"):($("#deleteFileBox").html("<button id='dfmbutton' type='button' class='btn btn-danger' onclick='deleteAllChecked()'>全部删除</button>"),$("#deleteFileMessage").text("提示：确定要彻底删除这"+a.length+"项么？该操作不可恢复")),$("#deleteFileModal").modal("toggle")}function deleteAllChecked(){var c,d,a=$(".info").get(),b=new Array;for(c=0;c<a.length;c++)b[c]=a[c].id;d=JSON.stringify(b),$("#dfmbutton").attr("disabled",!0),$("#deleteFileMessage").text("提示：正在删除，请稍候..."),$.ajax({type:"POST",dataType:"text",data:{strIdList:d},url:"homeController/deleteCheckedFiles.ajax",success:function(a){"mustLogin"==a?window.location.href="login.html":"noAuthorized"==a?($("#deleteFileMessage").text("提示：您的操作未被授权，删除失败"),$("#dfmbutton").attr("disabled",!1)):"errorParameter"==a?($("#deleteFileMessage").text("提示：参数不正确，未能全部删除文件"),$("#dfmbutton").attr("disabled",!1)):"cannotDeleteFile"==a?($("#deleteFileMessage").text("提示：出现意外错误，可能未能删除全部文件"),$("#dfmbutton").attr("disabled",!1)):"deleteFileSuccess"==a?($("#deleteFileModal").modal("hide"),showFolderView(locationpath)):($("#deleteFileMessage").text("提示：出现意外错误，可能未能删除全部文件"),$("#dfmbutton").attr("disabled",!1))},error:function(){$("#deleteFileMessage").text("提示：出现意外错误，可能未能删除全部文件"),$("#dfmbutton").attr("disabled",!1)}})}function playAudio(fileId){$("#audioPlayerModal").modal("show"),null==ap&&(ap=new APlayer({container:document.getElementById("aplayer"),lrcType:3,mutex:!0,volume:.7,theme:"#EDEDED",audio:[]}),ap.on("pause",function(){$("#playOrPause").html("<span class='glyphicon glyphicon-play' aria-hidden='true'></span>")}),ap.on("play",function(){$("#playOrPause").html("<span class='glyphicon glyphicon-pause' aria-hidden='true'></span>")})),ap.list.clear(),$.ajax({url:"homeController/playAudios.ajax",data:{fileId:fileId},type:"POST",dataType:"text",success:function(result){var ail=eval("("+result+")");ap.list.add(ail.as),ap.list.switch(ail.index),audio_play()},error:function(){alert("错误：无法获取音乐列表，请稍后再试"),closeAudioPlayer()}})}function closeAudioPlayer(){$("#audioPlayerModal").modal("hide"),ap.seek(0),ap.pause()}function audio_playOrPause(){ap.toggle()}function audio_play(){ap.play()}function audio_pasue(){ap.pause()}function audio_fw(){ap.skipForward()}function audio_bw(){ap.skipBack()}function audio_vulome_up(){ap.volume(ap.audio.volume+.1,!0)}function audio_vulome_down(){ap.volume(ap.audio.volume-.1,!0)}function sortbyfn(){$("#sortByFN").addClass("glyphicon glyphicon-triangle-bottom"),$("#sortByCD").removeClass(),$("#sortByFS").removeClass(),$("#sortByCN").removeClass(),folderView.fileList.sort(function(a,b){return a.fileName.localeCompare(b.fileName,"zh")}),folderView.folderList.sort(function(a,b){return a.folderName.localeCompare(b.folderName,"zh")}),showFolderTable(folderView)}function sortbycd(){$("#sortByFN").removeClass(),$("#sortByCD").addClass("glyphicon glyphicon-triangle-bottom"),$("#sortByFS").removeClass(),$("#sortByCN").removeClass(),folderView.fileList.sort(function(a,b){var c=a.fileCreationDate.replace("年","-").replace("月","-").replace("日",""),d=b.fileCreationDate.replace("年","-").replace("月","-").replace("日",""),e=new Date(Date.parse(c)).getTime()-new Date(Date.parse(d)).getTime();return-1*e}),folderView.folderList.sort(function(a,b){var c=a.folderCreationDate.replace("年","-").replace("月","-").replace("日",""),d=b.folderCreationDate.replace("年","-").replace("月","-").replace("日",""),e=new Date(Date.parse(c)).getTime()-new Date(Date.parse(d)).getTime();return-1*e}),showFolderTable(folderView)}function sortbyfs(){$("#sortByFN").removeClass(),$("#sortByCD").removeClass(),$("#sortByFS").addClass("glyphicon glyphicon-triangle-bottom"),$("#sortByCN").removeClass(),folderView.fileList.sort(function(a,b){return b.fileSize-a.fileSize}),showFolderTable(folderView)}function sortbycn(){$("#sortByFN").removeClass(),$("#sortByCD").removeClass(),$("#sortByFS").removeClass(),$("#sortByCN").addClass("glyphicon glyphicon-triangle-bottom"),folderView.fileList.sort(function(a,b){return a.fileCreator.localeCompare(b.fileCreator,"zh")}),folderView.folderList.sort(function(a,b){return a.folderCreator.localeCompare(b.folderCreator,"zh")}),showFolderTable(folderView)}function showOriginFolderView(){$("#sortByFN").removeClass(),$("#sortByCD").removeClass(),$("#sortByFS").removeClass(),$("#sortByCN").removeClass(),folderView=$.extend(!0,{},originFolderView),showFolderTable(folderView)}function startMoveFile(){var a,b;if($("#cutSignSp").hasClass("glyphicon glyphicon-import")&&void 0!==checkedMovefiles){for(a=new Array,b=0;b<checkedMovefiles.length;b++)a[b]=checkedMovefiles[b].id;JSON.stringify(a),$("#moveFilesMessage").text("提示：确定将这"+checkedMovefiles.length+"项移动到当前位置么？"),$("#moveFilesBox").html("<button id='dmvfbutton' type='button' class='btn btn-danger' onclick='doMoveFiles()'>全部移动</button>"),$("#moveFilesModal").modal("show")}else checkedMovefiles=$(".info").get(),void 0==checkedMovefiles||0==checkedMovefiles.length?($("#moveFilesMessage").text("提示：您还未选择任何文件，请先选中一些文件后再执行本操作（点击某一文件行来选中单一文件；按住Shift并点击文件行选中多个文件；使用Shift+A选中/取消选中所有文件）。"),$("#moveFilesModal").modal("show")):($("#cutSignTx").text("粘贴（"+checkedMovefiles.length+"）"),$("#cutSignSp").removeClass(),$("#cutSignSp").addClass("glyphicon glyphicon-import"))}function doMoveFiles(){var b,c,a=new Array;for(b=0;b<checkedMovefiles.length;b++)a[b]=checkedMovefiles[b].id;c=JSON.stringify(a),$("#dmvfbutton").attr("disabled",!0),$("#moveFilesMessage").text("提示：正在移动，请稍候..."),$.ajax({type:"POST",dataType:"text",data:{strIdList:c,locationpath:locationpath},url:"homeController/moveCheckedFiles.ajax",success:function(a){"mustLogin"==a?window.location.href="login.html":"noAuthorized"==a?($("#moveFilesMessage").text("提示：您的操作未被授权，移动失败"),$("#dmvfbutton").attr("disabled",!1)):"errorParameter"==a?($("#moveFilesMessage").text("提示：参数不正确，未能全部移动文件"),$("#dmvfbutton").attr("disabled",!1)):"cannotMoveFiles"==a?($("#moveFilesMessage").text("提示：出现意外错误，可能未能移动全部文件"),$("#dmvfbutton").attr("disabled",!1)):"moveFilesSuccess"==a?($("#moveFilesModal").modal("hide"),showFolderView(locationpath)):($("#moveFilesMessage").text("提示：出现意外错误，可能未能移动全部文件"),$("#dmvfbutton").attr("disabled",!1))},error:function(){$("#moveFilesMessage").text("提示：出现意外错误，可能未能移动全部文件"),$("#dmvfbutton").attr("disabled",!1)}})}var ap,zipTimer,folderView,originFolderView,fs,checkedMovefiles,constraintLevel,account,folderTypes,xhr,checkAll,locationpath="root",parentpath="null";$(function(){getServerOS(),showFolderView("root"),$(document).click(function(a){var b=$("#filetable")[0];a.target===b||$.contains(b,a.target)||$(".filerow").removeClass("info")}),$("#audioPlayerModal").on("hidden.bs.modal",function(){null!=ap&&(ap.seek(0),ap.pause())}),$("#downloadAllCheckedModal").on("hidden.bs.modal",function(){null!=zipTimer&&window.clearInterval(zipTimer)}),$("#loginModal").on("hidden.bs.modal",function(){$("#accountid").val(""),$("#accountpwd").val("")}),$("#loginModal").keypress(function(a){var b=a.keyCode?a.keyCode:a.which?a.which:a.charCode;13==b&&dologin()}),$("#loginModal").on("shown.bs.modal",function(){$("#accountid").focus()}),$("#newFolderModal").on("show.bs.modal",function(){if($("#folderalert").removeClass("alert"),$("#folderalert").removeClass("alert-danger"),$("#foldernamebox").removeClass("has-error"),$("#foldername").val(""),$("#foldertypelist").html(""),null!=account){$("#foldername").attr("folderConstraintLevel",constraintLevel+""),$("#newfoldertype").text(folderTypes[constraintLevel]);for(var b=constraintLevel;b<folderTypes.length;b++)$("#foldertypelist").append("<li><a onclick='changeNewFolderType("+b+")'>"+folderTypes[b]+"</a></li>")}else $("#foldertypelist").append("<li><a onclick='changeNewFolderType(0)'>"+folderTypes[0]+"</a></li>")}),$("#renameFolderModal").on("show.bs.modal",function(){if($("#newfolderalert").removeClass("alert"),$("#newfolderalert").removeClass("alert-danger"),$("#folderrenamebox").removeClass("has-error"),$("#newfolderalert").text(""),$("#editfoldertypelist").html(""),null!=account)for(var b=constraintLevel;b<folderTypes.length;b++)$("#editfoldertypelist").append("<li><a onclick='changeEditFolderType("+b+")'>"+folderTypes[b]+"</a></li>");else $("#editfoldertypelist").append("<li><a onclick='changeEditFolderType(0)'>"+folderTypes[0]+"</a></li>")}),document.ondragover=function(a){a.preventDefault(),a.stopPropagation()},document.ondrop=function(a){var b,c,d,e,f,g;if(a.preventDefault(),a.stopPropagation(),null!=folderView.authList)if(checkAuth(folderView.authList,"U")){if(b=a.dataTransfer,c=!0,void 0!==b.items)for(d=0;d<b.items.length;d++)e=b.items[d],"file"===e.kind&&e.webkitGetAsEntry().isFile||(c=!1);else for(d=0;d<b.files.length;d++)if(f=df.files[d],f.type);else try{g=new FileReader,g.readAsDataURL(f.slice(0,10)),g.addEventListener("load",function(){},!1),g.addEventListener("error",function(){c=!1},!1)}catch(a){c=!1}c?(fs=a.dataTransfer.files,showfilepath(),showUploadFileModel(),checkUploadFile()):alert("提示：您拖入的文件中包含了一个或多个文件夹，无法进行上传。")}else alert("您不具备上传权限，无法上传文件。");else alert("您不具备上传权限，无法上传文件。")},$(document).keypress(function(a){var b=a.keyCode?a.keyCode:a.which?a.which:a.charCode;65==b&&window.event.shiftKey&&checkallfile()}),$("#moveFilesModal").on("hidden.bs.modal",function(){checkedMovefiles=void 0,$("#cutSignTx").text("剪切"),$("#cutSignSp").removeClass(),$("#cutSignSp").addClass("glyphicon glyphicon-scissors"),$("#moveFilesBox").html("")}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)})}),folderTypes=["公开的","仅小组","仅创建者"],checkAll=!0;